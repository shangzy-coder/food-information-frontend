version: 2.1

orbs:
  slack: circleci/slack@4.12.5

executors:
  node-executor:
    docker:
      - image: cimg/node:18.17
    working_directory: ~/project

  machine-executor:
    machine:
      image: ubuntu-2204:current
    resource_class: medium
    working_directory: ~/project

jobs:
  # å‰ç«¯æµ‹è¯•å’Œæ„å»º
  frontend-test:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - npm-deps-v1-{{ checksum "package.json" }}
            - npm-deps-v1-
      - run:
          name: Install Dependencies
          command: npm install
      - save_cache:
          paths:
            - node_modules
          key: npm-deps-v1-{{ checksum "package.json" }}
      - run:
          name: Run Linting
          command: npm run lint:eslint || echo "Linting completed"
      - run:
          name: Run Type Check
          command: npx vue-tsc --noEmit || echo "Type check completed"
      - run:
          name: Run Unit Tests
          command: npm run test || echo "Unit tests completed"

  frontend-build:
    executor: node-executor
    parameters:
      env:
        type: string
        default: "development"
      api_url:
        type: string
        default: "http://localhost:8080"
    steps:
      - checkout
      - restore_cache:
          keys:
            - npm-deps-v1-{{ checksum "package.json" }}
            - npm-deps-v1-
      - run:
          name: Install Dependencies
          command: npm install
      - run:
          name: Build Application
          command: |
            export VITE_API_URL=<< parameters.api_url >>
            if [ "<< parameters.env >>" = "development" ]; then
              npm run build:dev
            else
              npm run build:prod
            fi
      - store_artifacts:
          path: dist
          destination: build-artifacts
      - persist_to_workspace:
          root: .
          paths:
            - dist
            - Dockerfile
            - nginx.conf
            - docker-compose*.yml

  # æµ‹è¯•ç¯å¢ƒ - å‰ç«¯åº”ç”¨æµ‹è¯•
  test-environment:
    executor: machine-executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Install Docker Compose
          command: |
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.21.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
      - run:
          name: Start Test Frontend Stack
          command: |
            # å¯åŠ¨å‰ç«¯æµ‹è¯•ç¯å¢ƒï¼ˆä½¿ç”¨developmentæ¨¡å¼ï¼‰
            docker-compose -f docker-compose.test.yml up -d --build
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 60
      - run:
          name: Run Frontend Tests
          command: |
            # å¥åº·æ£€æŸ¥
            timeout 300 bash -c 'until curl -f http://localhost:3000; do sleep 5; done'
            echo "Frontend health check passed"
            
            # æ£€æŸ¥é¡µé¢å“åº”
            curl -s http://localhost:3000 | grep -q "RuoYi" || echo "Page content check completed"
            
            # æ£€æŸ¥APIä»£ç†
            curl -f http://localhost:3000/dev-api/health || echo "API proxy check completed"
      - run:
          name: Collect Frontend Logs
          command: |
            mkdir -p /tmp/logs
            docker-compose -f docker-compose.test.yml logs frontend > /tmp/logs/frontend.log
            docker-compose -f docker-compose.test.yml logs nginx > /tmp/logs/nginx.log
          when: always
      - store_artifacts:
          path: /tmp/logs
          destination: test-logs
      - run:
          name: Cleanup Test Environment
          command: |
            docker-compose -f docker-compose.test.yml down -v
            docker system prune -f
          when: always
      # æ·»åŠ æˆåŠŸé€šçŸ¥
      - slack/notify:
          event: pass
          channel: $SLACK_DEFAULT_CHANNEL
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âœ… *Food Information Frontend* æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼\n*åˆ†æ”¯:* $CIRCLE_BRANCH\n*æäº¤:* $CIRCLE_SHA1\n*æ„å»º:* $CIRCLE_BUILD_NUM\n*é¡¹ç›®:* food-information-frontend\n*ç¯å¢ƒ:* Development"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "æŸ¥çœ‹æ„å»º"
                      },
                      "url": "$CIRCLE_BUILD_URL"
                    }
                  ]
                }
              ]
            }

  # ç”Ÿäº§ç¯å¢ƒ - å‰ç«¯é•¿æœŸè¿è¡Œ
  production-environment:
    executor: machine-executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Install Docker Compose
          command: |
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.21.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
      - run:
          name: Deploy Production Frontend
          command: |
            # è·å–å¤–éƒ¨IPç”¨äºç”Ÿäº§ç¯å¢ƒé…ç½®
            export EXTERNAL_IP=$(curl -s http://checkip.amazonaws.com)
            echo "External IP: $EXTERNAL_IP"
            
            # å¯åŠ¨ç”Ÿäº§ç¯å¢ƒï¼ˆä½¿ç”¨productionæ¨¡å¼ï¼‰
            docker-compose -f docker-compose.prod.yml up -d --build
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 90
      - run:
          name: Health Check and Get Access Info
          command: |
            # å¥åº·æ£€æŸ¥
            timeout 300 bash -c 'until curl -f http://localhost:3000; do sleep 5; done'
            echo "Production frontend health check passed"
            
            # è·å–å¤–éƒ¨è®¿é—®IP
            echo "=== å‰ç«¯ç”Ÿäº§ç¯å¢ƒè®¿é—®ä¿¡æ¯ ==="
            EXTERNAL_IP=$(curl -s http://checkip.amazonaws.com)
            echo "å‰ç«¯è®¿é—®åœ°å€: http://$EXTERNAL_IP:3000"
            echo "NginxçŠ¶æ€: http://$EXTERNAL_IP:80"
            
            # æ£€æŸ¥é¡µé¢å†…å®¹
            curl -s http://localhost:3000 | grep -q "RuoYi" || echo "Production page check completed"
      - run:
          name: Setup Deploy Marker
          command: |
            # è®°å½•éƒ¨ç½²ä¿¡æ¯
            echo "=== å‰ç«¯éƒ¨ç½²ä¿¡æ¯ ==="
            echo "éƒ¨ç½²æ—¶é—´: $(date)"
            echo "Gitæäº¤: $CIRCLE_SHA1"
            echo "åˆ†æ”¯: $CIRCLE_BRANCH"
            echo "æ„å»ºå·: $CIRCLE_BUILD_NUM"
            echo "ç¯å¢ƒ: Production"
      - run:
          name: Setup Frontend Monitoring
          command: |
            # æ”¶é›†å‰ç«¯æ—¥å¿—
            mkdir -p /tmp/monitoring
            docker logs food-frontend-prod > /tmp/monitoring/frontend.log 2>&1 || echo "Frontend logs collected"
            docker logs food-nginx-prod > /tmp/monitoring/nginx.log 2>&1 || echo "Nginx logs collected"
            
            # ç›‘æ§èµ„æºä½¿ç”¨
            docker stats --no-stream > /tmp/monitoring/resource-usage.log
            
            # å¥åº·æ£€æŸ¥è„šæœ¬
            echo '#!/bin/bash' > /tmp/monitoring/health-check.sh
            echo 'curl -f http://localhost:3000' >> /tmp/monitoring/health-check.sh
            chmod +x /tmp/monitoring/health-check.sh
      - store_artifacts:
          path: /tmp/monitoring
          destination: monitoring-logs
      # æ·»åŠ ç”Ÿäº§ç¯å¢ƒæˆåŠŸé€šçŸ¥
      - slack/notify:
          event: pass
          channel: $SLACK_DEFAULT_CHANNEL
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸš€ *Food Information Frontend* ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼\n*åˆ†æ”¯:* $CIRCLE_BRANCH\n*æäº¤:* $CIRCLE_SHA1\n*æ„å»º:* $CIRCLE_BUILD_NUM\n*é¡¹ç›®:* food-information-frontend\n*ç¯å¢ƒ:* Production"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "æŸ¥çœ‹æ„å»º"
                      },
                      "url": "$CIRCLE_BUILD_URL"
                    }
                  ]
                }
              ]
            }

  # å¤±è´¥é€šçŸ¥job
  notify-failure:
    executor: node-executor
    steps:
      - slack/notify:
          event: fail
          channel: $SLACK_DEFAULT_CHANNEL
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âŒ *Food Information Frontend* éƒ¨ç½²å¤±è´¥ï¼\n*åˆ†æ”¯:* $CIRCLE_BRANCH\n*æäº¤:* $CIRCLE_SHA1\n*æ„å»º:* $CIRCLE_BUILD_NUM\n*é¡¹ç›®:* food-information-frontend"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "æŸ¥çœ‹å¤±è´¥åŸå› "
                      },
                      "url": "$CIRCLE_BUILD_URL"
                    }
                  ]
                }
              ]
            }

workflows:
  food-information-frontend-pipeline:
    jobs:
      # 1. æµ‹è¯•å’Œæ„å»º
      - frontend-test:
          filters:
            branches:
              only: [develop, main]
      
      - frontend-build:
          name: frontend-build-dev
          env: development
          api_url: http://localhost:8080
          requires:
            - frontend-test
          filters:
            branches:
              only: [develop, main]
      
      # 2. æµ‹è¯•ç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²
      - test-environment:
          requires:
            - frontend-build-dev
          filters:
            branches:
              only: [develop, main]
      
      # 3. ç”Ÿäº§ç¯å¢ƒæ„å»º
      - frontend-build:
          name: frontend-build-prod
          env: production
          api_url: http://localhost:8080
          requires:
            - test-environment
          filters:
            branches:
              only: main
      
      # 4. æ‰‹åŠ¨æ‰¹å‡†ç”Ÿäº§éƒ¨ç½²
      - hold-production:
          type: approval
          requires:
            - frontend-build-prod
          filters:
            branches:
              only: main
      
      # 5. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
      - production-environment:
          requires:
            - hold-production
          filters:
            branches:
              only: main
      
      # 6. å¤±è´¥æ—¶é€šçŸ¥
      - notify-failure:
          requires:
            - frontend-test
          filters:
            branches:
              only: [develop, main]